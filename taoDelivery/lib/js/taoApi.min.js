
var URI={'LABEL':'http://www.w3.org/2000/01/rdf-schema#label','ENDORSMENT':'##NAMESPACE#ENDORSMENT','SCORE':'##NAMESPACE#SCORE','SCORE_MIN':'##NAMESPACE#SCORE_MIN','SCORE_MAX':'##NAMESPACE#SCORE_MAX','ANSWERED_VALUES':'##NAMESPACE#ANSWERED_VALUES','SUBJECT':'http://www.tao.lu/Ontologies/TAOSubject.rdf#Subject','SUBJETC_LOGIN':'http://www.tao.lu/Ontologies/generis.rdf#login','SUBJETC_FIRSTNAME':'http://www.tao.lu/Ontologies/generis.rdf#userFirstName','SUBJETC_LASTNAME':'http://www.tao.lu/Ontologies/generis.rdf#userLastName','ITEM':'http://www.tao.lu/Ontologies/TAOItem.rdf#Item','PROCESS':'http://www.tao.lu/middleware/taoqual.rdf#i119010455660544','TEST':'http://www.tao.lu/Ontologies/TAOTest.rdf#Test','DELIVERY':'http://www.tao.lu/Ontologies/TAODelivery.rdf#Delivery'};var STATE={'ITEM':{'PRE_FINISHED':'pre_item_finished','FINISHED':'item_finished','POST_FINISHED':'post_item_finished'}};
function TaoStack(){this.dataSource=new Object();this.dataSource.environment={'type':'async','url':root_url+'/taoDelivery/ResultDelivery/initialize','params':{}};this.dataSource.settings={'format':'json','method':'post','load':'onInit'};this.dataStore=new Object();this.initDataSource=function(environment,settings,source){if($.inArray(environment.type,['manual','sync','async'])>-1){this.dataSource.environment.type=environment.type;if(this.dataSource.environment.type!='manual'){if(environment.url){if(/(\/[-a-z\d%_.~+]*)*(\?[;&a-z\d%_.~+=-]*)?(\#[-a-z\d_]*)?$/.test(environment.url)){this.dataSource.environment.url=url;}}
if($.isPlainObject(environment.params)){for(key in params){if(isScalar(environment.params[key])){this.dataSource.environment.params[key]=environment.params[key]+'';}}}}
if($.isPlainObject(settings)){if(settings.method){if(/^get|post$/i.test(settings.method)){this.dataSource.settings.method=settings.method;}}}
if(this.dataSource.settings.load=='onInit'){this.loadData(source);}}};this.loadData=function(source){var populateData=function(data,instance){if($.isPlainObject(data)){for(key in data){for(uriKey in URI){if(URI[uriKey]==key||$.inArray(key,['token','localNamespace'])>-1){instance.dataStore[key]=data[key];}}}}};if(this.dataSource.environment.type=='manual'&&source!=null){populateData(source,this);}
else{var params=this.dataSource.environment.params;var instance=this;$.ajax({'url':this.dataSource.environment.url,'data':params,'type':this.dataSource.settings.method,'async':(this.dataSource.environment.type=='async'),'dataType':this.dataSource.settings.format,'success':function(data){if(data.token){populateData(data,instance);}}});}};this.dataPush=new Object();this.dataPush.environment={'url':root_url+'/taoDelivery/ResultDelivery/save','params':{'token':this.dataStore.token}};this.dataPush.settings={'format':'json','method':'post','async':false,'clearAfter':true};this.initPush=function(environment,settings){if($.isPlainObject(environment)){if(environment.url){if(/(\/[-a-z\d%_.~+]*)*(\?[;&a-z\d%_.~+=-]*)?(\#[-a-z\d_]*)?$/.test(environment.url)){this.dataPush.environment.url=environment.url;}}
if($.isPlainObject(environment.params)){for(key in environment.params){if(isScalar(environment.params[key])&&!this.dataPush.environment.params[key]){this.dataPush.environment.params[key]=environment.params[key];}}}}
if($.isPlainObject(settings)){if(settings.method){if(/^get|post$/i.test(settings.method)){this.dataPush.settings.method=settings.method;}}
if(settings.async===false){this.dataPush.settings.async=false;}
if(settings.clearAfter===false){this.dataPush.settings.clearAfter=false;}}};this.push=function(){var params=this.dataPush.environment.params;if(params.token==undefined){params.token=this.dataStore.token;}
params['taoVars']=new Object();params['userVars']=this.userVars;for(key in this.taoVars){if(/^##NAMESPACE#/.test(key)&&this.dataStore.localNamespace!=undefined){newkey=key.replace('##NAMESPACE',this.dataStore.localNamespace);params['taoVars'][newkey]=this.taoVars[key];}
else{params['taoVars'][key]=this.taoVars[key];}}
if(this.dataPush.settings.async===true){var _instance=this;$.ajax({'url':this.dataPush.environment.url,'data':params,'type':this.dataPush.settings.method,'async':true,'dataType':this.dataPush.settings.format,'success':function(data){if(data.saved==true){if(_instance.dataPush.settings.clearAfter===true){_instance.taoVars=new Object();_instance.userVars=new Object();}}}});}
else{received=$.parseJSON($.ajax({async:false,url:this.dataPush.environment.url,data:params,type:this.dataPush.settings.method}).responseText);if(received.saved==true){if(this.dataPush.settings.clearAfter===true){this.taoVars=new Object();this.userVars=new Object();}}}};this.taoVars=new Object();this.getTaoVar=function(key,label){var value=false;if(this.taoVars[key]){value=this.taoVars[key];}
else if(this.dataStore[key]){value=this.dataStore[key];}
if($.isPlainObject(value)){if((value['uri']!=undefined&&value[URI.LABEL]!=undefined&&value.length==2)||label){return value[URI.LABEL];}}
return value;};this.setTaoVar=function(key,value,property){if(isScalar(value)){var currentValue=this.getTaoVar(key);if($.isPlainObject(currentValue)){if(property){this.taoVars[key][property]=value;}
else if(value.indexOf('uri')>-1&&value.indexOf(URI.LABEL)>-1){this.taoVars[key][URI.LABEL]=value;}}
else{this.taoVars[key]=value;}}};this.userVars=new Object();this.getUserVar=function(key){return(this.userVars[key])?this.userVars[key]:false;};this.setUserVar=function(key,value){if(isScalar(value)){this.userVars[key]=value;}};}
function isScalar(value){return($.inArray((typeof value).toLowerCase(),['string','number','int','float','boolean'])>-1);}
function EventTracer(options){var _this=this;this.eventPool=new Array();this.eventsToBeSend=new Array();this.opts={POOL_SIZE:500,MIN_POOL_SIZE:200,MAX_POOL_SIZE:5000,time_limit_for_ajax_request:2000,eventsToBeSendCursor:-1,ctrlPressed:false,altPressed:false};if(options!=null&&options!=undefined){$.extend(this.opts,options);}
this.EVENTS_TO_CATCH=new Object();this.ATTRIBUTES_TO_CATCH=new Array();this.sourceService={type:'sync',data:null,url:'/taoDelivery/ResultDelivery/getEvents',params:{},method:'post',format:'json'};this.destinationService={url:'/taoDelivery/ResultDelivery/traceEvents',params:{},method:'post',format:'json'};this.initSourceService=function(environment){if($.isPlainObject(environment)){if($.inArray(environment.type,['manual','sync'])>-1){this.sourceService.type=environment.type;if(this.sourceService.type=='manual'&&$.isPlainObject(environment.data)){this.sourceService.data=environment.data;}
else{if(source.url){if(/(\/[-a-z\d%_.~+]*)*(\?[;&a-z\d%_.~+=-]*)?(\#[-a-z\d_]*)?$/.test(environment.url)){this.sourceService.url=environment.url;}}
if($.isPlainObject(environment.params)){for(key in environment.params){if(isScalar(environment.params[key])){this.sourceService.params[key]=environment.params[key];}}}
if(environment.method){if(/^get|post$/i.test(environment.method)){this.sourceService.method=environment.method;}}}}}
if(this.sourceService.type=='manual'&&this.sourceService.data!=null){this.EVENTS_TO_CATCH=this.setEventsToCatch(this.sourceService.data);}
if(this.sourceService.type=='sync'&&this.sourceService.url!=''){received=$.parseJSON($.ajax({async:false,url:this.sourceService.url,data:this.sourceService.params,type:this.sourceService.method}).responseText);if(received){this.EVENTS_TO_CATCH=this.setEventsToCatch(received);}}
if(this.EVENTS_TO_CATCH.bubbling!=undefined){this.bind_platform();}};this.initDestinationService=function(environment){if($.isPlainObject(environment)){if(environment.url){if(/(\/[-a-z\d%_.~+]*)*(\?[;&a-z\d%_.~+=-]*)?(\#[-a-z\d_]*)?$/.test(environment.url)){this.destinationService.url=environment.url;}}
if($.isPlainObject(environment.params)){for(key in environment.params){if(isScalar(environment.params[key])){this.destinationService.params[key]=environment.params[key];}}}
if(environment.method){if(/^get|post$/i.test(environment.method)){this.destinationService.method=environment.method;}}}};this.setEventsToCatch=function(data)
{if(data.type.length>0)
{var EVENTS_TO_CATCH={bubbling:[],nonBubbling:[]};if(data.type=='catch')
{for(i in data.list)
{if($.inArray(i,['click','dblclick','change','submit','select','mousedown','mouseup','mouseenter','mousemove','mouseout'])>-1)
{EVENTS_TO_CATCH.bubbling.push(i);}
else
{EVENTS_TO_CATCH.nonBubbling.push(i);}
this.ATTRIBUTES_TO_CATCH[i]=data.list[i];}}
else
{EVENTS_TO_CATCH={bubbling:['click','dblclick','change','submit','select','mousedown','mouseup','mouseenter','mousemove','mouseout'],nonBubbling:['blur','focus','load','resize','scroll','keyup','keydown','keypress','unload','beforeunload','select','submit']};for(i in data.list)
{remove_array(data.list[i].event,EVENTS_TO_CATCH.bubbling);remove_array(data.list[i].event,EVENTS_TO_CATCH.nonBubbling);}}}
else
{EVENTS_TO_CATCH={bubbling:['click','dblclick','change','submit','select','mousedown','mouseup','mouseenter','mousemove','mouseout'],nonBubbling:['blur','focus','load','resize','scroll','keyup','keydown','keypress','unload','beforeunload','select','submit']};}
return EVENTS_TO_CATCH;};this.bind_platform=function()
{$('body').bindDom(this);$('body').bind(this.EVENTS_TO_CATCH.bubbling.join(' '),this.eventStation);};this.unbind_platform=function()
{$('body').unbind(EVENTS_TO_CATCH.bubbling.join(' '),this.eventStation);$('body').unBindDom(this);};this.describeEvent=function(e,pload)
{if(e.target&&(typeof(e.target['value'])!='undefined')&&(e.target['value']!=-1)&&(e.target['value']!=''))
{pload['value']=e.target['value'];}
for(var i in e)
{if((typeof(e[i])!='undefined')&&(typeof(e[i])!='object')&&(typeof(e[i])!='function')&&(e[i]!=''))
{if((i!='cancelable')&&(i!='contentEditable')&&(i!='cancelable')&&(i!='bubbles')&&(i.substr(0,6)!='jQuery'))
{pload[i]=e[i];}}}};this.describeElement=function(e,pload)
{for(var i in e.target)
{try
{if(((typeof(e.target[i])=='string')&&(e.target[i]!=''))|(typeof(e.target[i])=='number'))
{if((!in_array(i,position_pload_array))&&(!in_array(i,ignored_pload_element_array))&&(i.substr(0,6)!='jQuery'))
{pload[i]=''+e.target[i];}}}
catch(e){}}
if(typeof(e.target.nodeName)!='undefined')
{switch(e.target.nodeName.toLowerCase())
{case'select':{pload['value']=$(e.target).val();if(typeof(pload['value'])=='array')
{pload['value']=pload['value'].join('|');}
break;}
case'textarea':{pload['value']=$(e.target).val();break;}
case'input':{pload['value']=$(e.target).val();break;}
case'html':{if(e.target.ownerDocument.designMode=='on')
{pload['text']=$(e.target).contents('body').html();}
break;}}}};this.setEventParameters=function(e,pload)
{for(var i in this.ATTRIBUTES_TO_CATCH[e.type])
{if(typeof(e[this.ATTRIBUTES_TO_CATCH[e.type][i]])!='undefined')
{pload[this.ATTRIBUTES_TO_CATCH[e.type][i]]=e[this.ATTRIBUTES_TO_CATCH[e.type][i]];}
else
{if(typeof(e.target[this.ATTRIBUTES_TO_CATCH[e.type][i]])!='undefined')
{pload[this.ATTRIBUTES_TO_CATCH[e.type][i]]=e.target[this.ATTRIBUTES_TO_CATCH[e.type][i]];}}}};this.hooks=function(e){return(e.name=='BUSINESS');};this.eventStation=function(e){var keyCode=e.keyCode?e.keyCode:e.charCode;if(e.type=='keypress')
{try
{if((typeof(keyCode)!='undefined')&&((keyCode==116)|(keyCode==115)|((e.ctrlKey)&&((keyCode==114)|(keyCode==115)|(keyCode==116)|(keyCode==112)|(keyCode==110)|(keyCode==111)|(keyCode==79)))|((e.altKey)&&(keyCode==9))|(keyCode==91)|(keyCode==92)|(keyCode==37)|(keyCode==39)))
{e.preventDefault();return false;}}
catch(e){}}
var target_tag=e.target.nodeName?e.target.nodeName.toLowerCase():e.target.type;var idElement;if((e.target.id)&&(e.target.id.length>0))
{idElement=e.target.id;}
else
{idElement='noID';}
var pload={'id':idElement};if((typeof(this.ATTRIBUTES_TO_CATCH)!='undefined')&&(typeof(this.ATTRIBUTES_TO_CATCH[e.type])!='undefined')&&(this.ATTRIBUTES_TO_CATCH[e.type].length>0))
{this.setEventParameters(e,pload);}
else
{if(typeof(this.describeEvent)!='undefined')
{this.describeEvent(e,pload);}
if(typeof(this.describeElement)!='undefined')
{this.describeElement(e,pload);}}
_this.feedTrace(target_tag,e.type,e.timeStamp,pload);};this.feedTrace=function(target_tag,event_type,time,pLoad)
{var send_right_now=false;var event='{"name":"'+target_tag+'","type":"'+event_type+'","time":"'+time+'"';if(typeof(pLoad)=='string')
{event=event+',"pLoad":"'+pLoad+'"';}
else
{for(var prop_name in pLoad)
{event=event+',"'+prop_name+'":"'+pLoad[prop_name]+'"';}}
event=event+'}';if(typeof(this.hooks)!="undefined")
{send_right_now=this.hooks($.parseJSON(event));}
this.eventPool.push(event);if((this.eventPool.length>this.opts.POOL_SIZE)||(send_right_now))
{this.prepareFeedTrace();}};this.prepareFeedTrace=function()
{var currentLength=this.eventsToBeSend.length;var temp_array=new Array();for(var i=0;((this.eventPool.length>0)&&(i<this.opts.POOL_SIZE));i++)
{temp_array.push(this.eventPool.shift());}
this.eventsToBeSend.push(temp_array);this.sendFeedTrace();};this.sendFeedTrace=function()
{var events=this.eventsToBeSend.pop();var sent_timeStamp=new Date().getTime();var params=$.extend({'events':events},this.destinationService.params);$.ajax({url:this.destinationService.url,data:params,type:this.destinationService.method,async:true,datatype:this.destinationService.format,success:function(data,textStatus){_this.sendFeedTraceSucceed(data,textStatus,sent_timeStamp);},error:function(xhr,errorString,exception){_this.sendFeedTraceFail(xhr,errorString,exception,events);}});};this.sendFeedTraceSucceed=function(data,textStatus,sent_timeStamp)
{var request_time=(new Date()).getTime()-sent_timeStamp;if(request_time>this.opts.time_limit_for_ajax_request)
{this.increaseEventsPoolSize();}
else
{this.reduceEventsPoolSize();}
if(data.saved)
{this.eventsToBeSend.shift();}};this.increaseEventsPoolSize=function()
{if(this.opts.POOL_SIZE<this.opts.MAX_POOL_SIZE)
{this.opts.POOL_SIZE=Math.floor(this.opts.POOL_SIZE*2);}};this.reduceEventsPoolSize=function()
{if(this.opts.POOL_SIZE>this.opts.MIN_POOL_SIZE)
{this.opts.POOL_SIZE=Math.floor(this.opts.POOL_SIZE*0.75);}};this.sendFeedTraceFail=function(xhr,errorString,exception,events)
{this.increaseEventsPoolSize();this.eventsToBeSend.unshift(events);window.setInterval(this.sendAllFeedTrace_now,2000);};this.sendAllFeedTrace_now=function()
{var currentLength=this.eventsToBeSend.length;this.eventsToBeSend[currentLength]=Array();for(;this.eventPool.length>0;)
{this.eventsToBeSend[currentLength].push(this.eventPool.pop());}
var events=new Array();for(var j in this.eventsToBeSend)
{for(var i in this.eventsToBeSend[j])
{events.push(this.eventsToBeSend[j][i]);}}
var params=$.extend({'events':events},this.destinationService.params);var sent_timeStamp=new Date().getTime();$.ajax({url:this.destinationService.url,data:params,type:this.destinationService.method,async:false,datatype:this.destinationService.format,success:function(data,textStatus){_this.sendFeedTraceSucceed(data,textStatus,sent_timeStamp);},error:function(xhr,errorString,exception){_this.sendFeedTraceFail(xhr,errorString,exception,events);}});};}
jQuery.fn.bindDom=function(eventTracer)
{$(this).bind(eventTracer.EVENTS_TO_CATCH.nonBubbling.join(' '),eventTracer.eventStation);var childrens=$(this).children();if(childrens.length)
{childrens.bindDom(eventTracer);}};jQuery.fn.unBindDom=function(eventTracer)
{$(this).unbind(eventTracer.EVENTS_TO_CATCH.nonBubbling.join(' '),eventTracer.eventStation);var childrens=$(this).children();if(childrens.length)
{childrens.unBindDom(eventTracer);}};var ignored_pload_element_array=new Array('contentEditable','localName','tagname','textContent','namespaceURI','baseURI','innerHTML','defaultStatus','fullScreen','UNITSMAP','PROCESSURI','LANGID','ITEMID','ACTIVITYID','DURATION','ELEMENT_NODE','ATTRIBUTE_NODE','TEXT_NODE','CDATA_SECTION_NODE','ENTITY_REFERENCE_NODE','ENTITY_NODE','PROCESSING_INSTRUCTION_NODE','COMMENT_NODE','DOCUMENT_NODE','DOCUMENT_TYPE_NODE','DOCUMENT_FRAGMENT_NODE','NOTATION_NODE','DOCUMENT_POSITION_PRECEDING','DOCUMENT_POSITION_FOLLOWING','DOCUMENT_POSITION_CONTAINS','DOCUMENT_POSITION_CONTAINED_BY','DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC','DOCUMENT_POSITION_DISCONNECTED','childElementCount','LAYOUT_DIRECTION','CURRENTSTIMULUS','CURRENTITEMEXTENSION','CURRENTSTIMULUSEXTENSION','nodeType','tabIndex');var ignored_pload_event_array=new Array('cancelable','contentEditable','bubbles','tagName','localName','timeStamp','type');jQuery.event.special.changeCss={setup:function(){},teardown:function(){}};jQuery.event.special.reloadMapEvent={setup:function(){},teardown:function(){}};
var taoStack=new TaoStack();var root_url=root_url||'';function getEndorsment(){return taoStack.getTaoVar(URI.ENDORSMENT);}
function setEndorsment(endorsment){taoStack.setTaoVar(URI.ENDORSMENT,(endorsment===true));}
function getScore(){return taoStack.getTaoVar(URI.SCORE);}
function setScore(score){if(isScalar(score)){if(typeof(score)=='boolean'){(score===true)?score=1:score=0;}
taoStack.setTaoVar(URI.SCORE,score);}}
function getScoreRange(){return{'min':taoStack.getTaoVar(URI.SCORE_MIN),'max':taoStack.getTaoVar(URI.SCORE_MAX)};}
function setScoreRange(max,min){if(max!=undefined){if(min==undefined){min=0;}
taoStack.setTaoVar(URI.SCORE_MIN,min);taoStack.setTaoVar(URI.SCORE_MAX,max);}}
function getAnsweredValues(){return taoStack.getTaoVar(URI.ANSWERED_VALUES);}
function setAnsweredValues(values){taoStack.setTaoVar(URI.ANSWERED_VALUES,values);}
function getSubject(){return taoStack.getTaoVar(URI.SUBJECT);}
function getSubjectLogin(){var subject=getSubject();return(subject)?subject[URI.SUBJETC_LOGIN]:'';}
function getSubjectName(){var subject=getSubject();if(subject){return subject[URI.SUBJETC_FIRSTNAME]+' '+subject[URI.SUBJETC_LASTNAME];}
return'';}
function getItem(){return taoStack.getTaoVar(URI.ITEM);}
function getTest(){return taoStack.getTaoVar(URI.TEST);}
function getDelivery(){return taoStack.getTaoVar(URI.DELIVERY);}
function setUserVar(key,value){taoStack.setUserVar(key,value);}
function getUserVar(key){return taoStack.getUserVar(key);}
if(typeof(finish)!='function'){function finish(){$(window).trigger(STATE.ITEM.PRE_FINISHED);$(window).trigger(STATE.ITEM.FINISHED);$(window).trigger(STATE.ITEM.POST_FINISHED);}
function onFinish(callback){$(window).bind(STATE.ITEM.FINISHED,callback);}
function beforeFinish(callback){$(window).bind(STATE.ITEM.PRE_FINISHED,callback);}
function afterFinish(callback){$(window).bind(STATE.ITEM.POST_FINISHED,callback);}}
function getToken(){return taoStack.dataStore.token;}
function initDataSource(environment,settings){taoStack.initDataSource(environment,settings,null);}
function initManualDataSource(source){taoStack.initDataSource({type:'manual'},null,source);}
function initPush(environment,settings){taoStack.initPush(environment,settings);}
function push(){taoStack.push();}
beforeFinish(push);var eventTracer=new EventTracer();function logEvent(elementName,eventType,data){eventTracer.feedTrace(elementName,eventType,new Date().getTime(),data);}
function logCustomEvent(eventName,data){eventTracer.feedTrace('BUSINESS',eventName,new Date().getTime(),data);}
function initEventServices(source,destination){extendedParams={params:{token:getToken()}};eventTracer.initSourceService($.extend(true,source,extendedParams));eventTracer.initDestinationService($.extend(true,destination,extendedParams));}
beforeFinish(function(){eventTracer.sendAllFeedTrace_now();});