
var QTIWidget=function(options){var _this=this;this.opts=options;var qti_item_id="#"+this.opts["id"];this.choice=function(){var maxChoices=parseInt(_this.opts["maxChoices"]);if(maxChoices>1||maxChoices==0){_this.multiple_choice();}
else{_this.simple_choice();}};this.simple_choice=function(){$(qti_item_id).addClass('qti_simple_interaction');$(qti_item_id+" ul li").bind("click",function(){$(qti_item_id+" ul li").removeClass("tabActive");$(this).addClass("tabActive");});};this.multiple_choice=function(){$(qti_item_id).addClass('qti_multi_interaction');$(qti_item_id+" ul li").bind("click",function(){if($(this).hasClass("tabActive")){$(this).removeClass("tabActive");}
else{if($(qti_item_id+" ul li.tabActive").length<_this.opts["maxChoices"]||_this.opts["maxChoices"]==0){$(this).addClass("tabActive");}}});};this.inline_choice=function(){};this.order=function(){var sortableOptions={revert:true,axis:'y',containment:qti_item_id,placeholder:'sort-placeholder',tolerance:'pointer'};$(qti_item_id+" ul li").addClass('sort-vertical');if(_this.opts['orientation']){if(_this.opts['orientation']=='horizontal'){sortableOptions.axis='x';sortableOptions.placeholder='sort-placeholder-inline';sortableOptions['forcePlaceHolderWidth']=true;$(qti_item_id+" ul li").removeClass('sort-vertical').addClass('sort-horizontal').css('display','inline');}}
$(qti_item_id+" ul").sortable(sortableOptions);$(qti_item_id+" ul, li").disableSelection();};this.associate=function(){$(qti_item_id+" .qti_choice_list li").wrapInner("<div></div>");var maxBoxSize=0;$(qti_item_id+" ul.qti_choice_list li > div").each(function(){if($(this).width()>maxBoxSize){maxBoxSize=$(this).width();}});$(qti_item_id+" .qti_associate_container .qti_choice_list").height(parseFloat($(".qti_associate_container").height()));if(_this.opts["maxAssociations"]>0){var pairSize=_this.opts["maxAssociations"];}
else{var pairSize=parseInt($(qti_item_id+" .qti_choice_list li").length/2);}
for(var a=pairSize;a>0;a--){var currentPairName=_this.opts["id"]+"_"+a;$(qti_item_id+" .qti_associate_container").after("<ul class='qti_association_pair' id='"+currentPairName+"'><li id='"+currentPairName+"_A"+"'></li><li id='"+currentPairName+"_B"+"'></li></ul>");}
$(qti_item_id+" .qti_association_pair li").width(maxBoxSize+4);var pairBoxWidth=0;$(qti_item_id+" .qti_association_pair:first li").each(function(){pairBoxWidth+=$(this).width();});$(qti_item_id+" .qti_association_pair").width(pairBoxWidth+90);$(qti_item_id+" .qti_association_pair").css({position:"relative",margin:"0 auto",top:"10px"});$(qti_item_id+" .qti_association_pair").each(function(){$(this).after("<div class='qti_link_associate'></div>");$(qti_item_id+" .qti_link_associate:last").css("top",$(this).offset().top+23);$(qti_item_id+" .qti_link_associate:last").css("left",parseFloat($(this).find("li:first").offset().left)+parseFloat($(this).find("li:first").width())+14);});$(qti_item_id).height(($(qti_item_id+" .qti_link_associate:last").offset().top)-$(qti_item_id).offset().top);$(qti_item_id+" .qti_associate_container .qti_choice_list li > div").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},containment:qti_item_id,cursor:"move",revert:true});var removeFilledPair=function(jElement){var filledId=jElement.attr("id").replace('pair_','');var _matchMax=Number(_this.opts["matchMaxes"][filledId]["matchMax"]);var _current=Number(_this.opts["matchMaxes"][filledId]["current"]);if(_current>0){_this.opts["matchMaxes"][filledId]["current"]=_current-1;}
jElement.parents('li').removeClass('ui-state-highlight');jElement.remove();if(_current>=_matchMax){$("#"+filledId+" div").show();}};$(qti_item_id+" .qti_association_pair li").droppable({drop:function(event,ui){var draggedId=$(ui.draggable).parents().attr('id');if($(this).find("#pair_"+draggedId).length>0||/^pair_/.test($(ui.draggable).attr('id'))){return false;}
var _matchMax=Number(_this.opts["matchMaxes"][draggedId]["matchMax"]);var _current=Number(_this.opts["matchMaxes"][draggedId]["current"]);var _matchGroup=_this.opts["matchMaxes"][draggedId]["matchGroup"];if(/A$/.test($(this).attr('id'))){var opposite=$('#'+$(this).attr('id').replace(/_A$/,"_B")).find('.filled_pair:first');}
else{var opposite=$('#'+$(this).attr('id').replace(/_B$/,"_A")).find('.filled_pair:first');}
if(opposite.length>0){var oppositeId=opposite.attr('id').replace('pair_','');if(_matchGroup.length>0){if($.inArray(oppositeId,_matchGroup)<0){$(this).effect("highlight",{color:'#B02222'},2000);return false;}}
var _oppositeMatchGroup=_this.opts["matchMaxes"][oppositeId]["matchGroup"];if(_oppositeMatchGroup.length>0){if($.inArray(draggedId,_oppositeMatchGroup)<0){$(this).effect("highlight",{color:'#B02222'},2000);return false;}}}
$(this).addClass('ui-state-highlight');if($(this).html()!=''){$('.filled_pair',$(this)).each(function(){removeFilledPair($(this));});}
$(this).html("<div id='pair_"+draggedId+"' class='filled_pair'>"+$(ui.draggable).text()+"</div>");if(_current<_matchMax){_current++;_this.opts["matchMaxes"][draggedId]["current"]=_current;}
if(_current>=_matchMax){$(ui.draggable).hide();}
$(qti_item_id+" .filled_pair").width($(qti_item_id+" .qti_association_pair li").width());$(qti_item_id+" .filled_pair").height($(qti_item_id+" .qti_association_pair li").height());$(ui.helper).css({top:"0",left:"0"});$(qti_item_id+" .filled_pair").draggable({drag:function(event,ui){$(this).css("z-index","999");},stop:function(event,ui){removeFilledPair($(this));return true;},containment:qti_item_id,cursor:"move"});},hoverClass:'active'});};this.text_entry=function(){if(_this.opts['expectedLength']){length=parseInt(_this.opts['expectedLength']);$(qti_item_id).css('width',(length*10)+'px').attr('maxLength',length);}
_this.string_interaction();};this.extended_text=function(){if($(qti_item_id).get(0).nodeName.toLowerCase()=='textarea'){if(_this.opts['expectedLength']||_this.opts_this.opts['expectedLines']){baseWidth=parseInt($(qti_item_id).css('width'))|400;baseHeight=parseInt($(qti_item_id).css('height'))|100;if(_this.opts['expectedLength']){length=parseInt(_this.opts['expectedLength']);width=length*10;if(width>baseWidth){height=(width/baseWidth)*16;if(height>baseHeight){$(qti_item_id).css('height',height+'px');}}
$(qti_item_id).attr('maxLength',length);}
if(_this.opts['expectedLines']){$(qti_item_id).css('height',(parseInt(_this.opts['expectedLines'])*16)+'px');}}
_this.string_interaction();}
if($(qti_item_id).get(0).nodeName.toLowerCase()=='div'){if(_this.opts['expectedLength']){length=parseInt(_this.opts['expectedLength']);$(qti_item_id+" :text").css('width',(length*10)+'px').attr('maxLength',length);}
if(_this.opts['patternMask']){var pattern=new RegExp("/^"+_this.opts['patternMask']+"$/");$(qti_item_id+" :text").change(function(){$(this).removeClass('field-error');if(!pattern.test($(this).val())){$(this).addClass('field-error');}});}}};this.string_interaction=function(){if(_this.opts['patternMask']){var pattern=new RegExp("^"+_this.opts['patternMask']+"$");$(qti_item_id).change(function(){$(this).removeClass('field-error');if(!pattern.test($(this).val())){$(this).addClass('field-error');}});}
if(_this.opts['stringIdentifier']){$(qti_item_id).after("<input type='hidden' id='"+_this.opts['stringIdentifier']+"' />");$("#"+_this.opts['stringIdentifier']).addClass('qti_text_entry_interaction');$(qti_item_id).change(function(){$("#"+_this.opts['stringIdentifier']).val($(this).val());});}};this.hottext=function(){var maxChoices=(_this.opts['maxChoices'])?parseInt(_this.opts['maxChoices']):1;$(qti_item_id+" .hottext_choice").click(function(){if(maxChoices==0){$(this).toggleClass('hottext_choice_on');$(this).toggleClass('hottext_choice_off');}
if(maxChoices==1){$(qti_item_id+" .hottext_choice").removeClass('hottext_choice_on').addClass('hottext_choice_off');$(this).removeClass('hottext_choice_off').addClass('hottext_choice_on');}
if(maxChoices>1){if($(qti_item_id+" .hottext_choice_on").length<maxChoices||$(this).hasClass('hottext_choice_on')){$(this).toggleClass('hottext_choice_on');$(this).toggleClass('hottext_choice_off');}}});};this.gap_match=function(){$(qti_item_id+" .qti_choice_list").wrap("<div class='qti_gap_match_container'></div>");$(qti_item_id+" .qti_choice_list li").wrapInner("<div></div>");$(qti_item_id+" .qti_choice_list li:last").after("<li><div></div></li>");$(qti_item_id+" .qti_choice_list li:last").css('clear','both');$(qti_item_id+" .qti_choice_list").height(parseFloat($(".qti_gap_match_container").height()));var maxBoxSize=0;$(qti_item_id+" ul.qti_choice_list li > div").each(function(){if($(this).width()>maxBoxSize){maxBoxSize=$(this).width();}});maxBoxSize=((parseInt(maxBoxSize)/2)+5)+'px';$(qti_item_id+" .gap").css({"padding-left":maxBoxSize,"padding-right":maxBoxSize});$(qti_item_id+" .qti_gap_match_container .qti_choice_list li > div").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},containment:qti_item_id,revert:true,cursor:"move"});var removeFilledGap=function(jElement){var filledId=jElement.attr("id").replace('gap_','');var _matchMax=Number(_this.opts["matchMaxes"][filledId]["matchMax"]);var _current=Number(_this.opts["matchMaxes"][filledId]["current"]);if(_current>0){_this.opts["matchMaxes"][filledId]["current"]=_current-1;}
jElement.parent().css({"padding-left":maxBoxSize,"padding-right":maxBoxSize}).removeClass('dropped_gap');jElement.remove();if(_current>=_matchMax){$("#"+filledId+" div").show();}};$(qti_item_id+" .gap").droppable({drop:function(event,ui){var draggedId=$(ui.draggable).parent().attr("id");if($(this).find("#gap_"+draggedId).length>0||/^gap_/.test($(ui.draggable).attr('id'))){return false;}
var _matchMax=Number(_this.opts["matchMaxes"][draggedId]["matchMax"]);var _current=Number(_this.opts["matchMaxes"][draggedId]["current"]);var _matchGroup=_this.opts["matchMaxes"][draggedId]["matchGroup"];if(_matchGroup.length>0){if($.inArray($(this).attr('id'),_matchGroup)<0){$(this).effect("highlight",{color:'#B02222'},2000);return false;}}
var _gapMatchGroup=_this.opts["matchMaxes"][$(this).attr('id')]["matchGroup"];if(_gapMatchGroup.length>0){if($.inArray(draggedId,_gapMatchGroup)<0){$(this).effect("highlight",{color:'#B02222'},2000);return false;}}
if($(this).html()!=''){$('.filled_gap',$(this)).each(function(){removeFilledGap($(this));});}
$(this).css({'padding-left':'5px','padding-right':'5px'}).addClass('dropped_gap');$(this).html("<span id='gap_"+draggedId+"' class='filled_gap'>"+$(ui.draggable).text()+"</span>");if(_current<_matchMax){_current++;_this.opts["matchMaxes"][draggedId]["current"]=_current;}
if(_current>=_matchMax){$(ui.draggable).hide();}
$(qti_item_id+" .filled_gap").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");$(this).parent().addClass('ui-state-highlight');},stop:function(){$(this).parent().removeClass('ui-state-highlight');removeFilledGap($(this));},revert:false,containment:qti_item_id,cursor:"move"});},hoverClass:'active'});};this.match=function(){$(qti_item_id+" .choice_list:last").addClass('choice_list_cols');var cols=new Array();$(qti_item_id+" .choice_list_cols li").each(function(){cols.push(this.id);});$(qti_item_id+" .choice_list:first").addClass('choice_list_rows');var rows=new Array();$(qti_item_id+" .choice_list_rows li").each(function(){rows.push(this.id);});$(qti_item_id+" .choice_list_cols").after("<div class='match_node_container'></div>");$(qti_item_id+" .match_node_container").height(parseInt($(qti_item_id+" .choice_list_rows").height()));$(qti_item_id+" .match_node_container").css({'left':$(qti_item_id+" .choice_list_rows").width()});var maxHeight=25;$(qti_item_id+" .choice_list_cols li").each(function(){var height=parseInt($(this).height());if(height>maxHeight){maxHeight=height;}});$(qti_item_id+" .choice_list_cols li").each(function(){var li=$(this);li.css('width',li.width());var myDiv=$("<div />").css({'width':li.width(),'height':maxHeight+'px','border':li.css('border')});li.css('height','25px');$(this).wrapInner(myDiv)});$(qti_item_id+" .prompt").css('margin-bottom',(maxHeight-20)+'px');var i=0;var currentHeight=0;while(i<rows.length){var xnode='xnode_'+rows[i];var rowHeight=parseFloat($("#"+rows[i]).height());var j=0;while(j<cols.length){var ynode='ynode_'+cols[j];var node_id='match_node_'+i+'_'+j;$(qti_item_id+" .match_node_container").append("<div id='"+node_id+"' class='match_node "+xnode+" "+ynode+"'>&nbsp;</div>");left=0;if(j>0){p=$("#"+'match_node_'+i+'_'+(j-1)).position();left=parseInt(p.left)+parseInt($("#"+'match_node_'+i+'_'+(j-1)).width())+(12);}
var colWidth=parseFloat($("#"+cols[j]).width());$(qti_item_id+" #"+node_id).css({'top':((currentHeight)+(i*2))+'px','left':left+'px','width':colWidth+'px','height':rowHeight+'px'});j++;}
currentHeight+=rowHeight;i++;}
function getNodeXY(jElement){var x=null;var y=null;var classes=jElement.attr('class').split(' ');for(i in classes){if(/^xnode_/.test(classes[i])){x={'id':classes[i].replace('xnode_',''),'class':classes[i]};}
else if(/^ynode_/.test(classes[i])){y={'id':classes[i].replace('ynode_',''),'class':classes[i]};}
if(x!=null&&y!=null){break;}}
return{xnode:x,ynode:y};}
function deactivateNode(jElement){jElement.removeClass('tabActive');associations.splice(associations.indexOf(jElement.attr('id')),1);}
var maxAssociations=_this.opts['maxAssociations'];var associations=new Array();$(qti_item_id+" .match_node").click(function(){var elt=$(this);if(elt.hasClass('tabActive')){deactivateNode(elt);}
else{if(associations.length<maxAssociations||maxAssociations==0){var nodeXY=getNodeXY(elt);var _rowMatchGroup=_this.opts["matchMaxes"][nodeXY.xnode.id]['matchGroup'];if(_rowMatchGroup.length>0){if($.inArray(nodeXY.ynode.id,_rowMatchGroup)<0){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}
var _colMatchGroup=_this.opts["matchMaxes"][nodeXY.ynode.id]['matchGroup'];if(_colMatchGroup.length>0){if($.inArray(nodeXY.xnode.id,_colMatchGroup)<0){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}
var rowMatch=_this.opts["matchMaxes"][nodeXY.xnode.id]['matchMax'];if(rowMatch==1){$(qti_item_id+" ."+nodeXY.xnode['class']).each(function(){deactivateNode($(this));});}
else if(rowMatch>1){var rowMatched=$(qti_item_id+" ."+nodeXY.xnode['class']+".tabActive").length;if(rowMatched>=rowMatch){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}
var colMatch=_this.opts["matchMaxes"][nodeXY.ynode.id]['matchMax'];if(colMatch==1){$("."+nodeXY.ynode['class']).each(function(){deactivateNode($(this));});}
else if(colMatch>1){var colMatched=$(qti_item_id+" ."+nodeXY.ynode['class']+".tabActive").length;if(colMatched>=colMatch){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}
elt.addClass('tabActive');associations.push(elt.attr('id'));}}});};}
function QTIResultCollector(options){var _this=this;this.opts=options;this.id=options['id'];this.choice=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};var userData=new Array();$("#"+_this.id+" .tabActive").each(function(){if(_this.opts["maxChoices"]!=1)
result.value.push(this.id);else
result.value=this.id;});return result;};this.order=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":new Object()};var i=0;$("#"+_this.id+" ul.qti_choice_list li").each(function(){result.value[i]=this.id;i++;});return result;};this.associate=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};$("#"+_this.id+" .qti_association_pair").each(function(){if(!$(this).find('li:first').find('.filled_pair').length){return;}
var firstId=$(this).find('li:first').find('.filled_pair').attr('id').replace('pair_','');var lastId=$(this).find('li:last').find('.filled_pair').attr('id').replace('pair_','');var elt=null;if(_this.opts.responseBaseType=="pair"){elt=[firstId,lastId];}else if(_this.opts.responseBaseType=="directedPair"){elt={0:firstId,1:lastId};}
if(_this.opts["maxChoices"]!=1){result.value.push(elt);}else{result.value=elt;}});return result;};this.text=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":null};if($("#"+_this.id).get(0).nodeName.toLowerCase()!='div'){result.value=$("#"+_this.id).val();}
else{result.value=new Array();$("#"+_this.id+" :text").each(function(){result.value.push($(this).val());});}
return result;};this.text_entry=this.text;this.extended_text=this.text;this.inline_choice=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":$("#"+_this.id).val()};return result;};this.hottext=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};$("#"+_this.id+" .hottext_choice_on").each(function(){if(_this.opts["maxChoices"]!=1)
result.value.push(this.id.replace(/^hottext_choice_/,''));else
result.value=this.id.replace(/^hottext_choice_/,'');});return result;};this.gap_match=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};$("#"+_this.id+" .filled_gap").each(function(){var choiceId=$(this).attr('id').replace('gap_','');var groupId=$(this).parent().attr('id');result.value.push({0:groupId,1:choiceId});});return result;};this.match=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};$("#"+_this.id+" .tabActive").each(function(){var subset=new Object();var classes=$(this).attr('class').split(' ');if(classes.length>0){var i=0;while(i<classes.length){if(/^xnode_/.test(classes[i])){subset[0]=classes[i].replace('xnode_','');}
if(/^ynode_/.test(classes[i])){subset[1]=classes[i].replace('ynode_','');}
i++;}
result.value.push(subset);}});return result;};}
function qti_init(qti_initParam){for(var a in qti_initParam){qti_init_interaction(qti_initParam[a]);}}
function qti_init_interaction(initObj){var myQTIWidget=new QTIWidget(initObj);var myResultCollector=new QTIResultCollector(initObj);var typeName=initObj["type"].replace('qti_','').replace('_interaction','');if(!myQTIWidget[typeName]){console.log("Error: Unknow widget "+typeName);}
myQTIWidget[typeName].apply();$("#qti_validate").bind("click",function(){var result=myResultCollector[typeName].apply();matchingSetResponses([result]);});}